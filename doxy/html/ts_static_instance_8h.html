<!-- HTML header for doxygen 1.8.12-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TSDuck: tsStaticInstance.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxy-style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img src="tsduck-32.png"/></td>
   <td id="projectalign"><span id="projectname">TSDuck</span>
    <span id="projectnumber">Version 3.10-675</span>
    <span id="projectbrief">(TSDuck - The MPEG Transport Stream Toolkit)</span>
   </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ts_static_instance_8h.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a>  </div>
  <div class="headertitle">
<div class="title">tsStaticInstance.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Declare the initialization-order-safe macros for static object instances.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:abc69775def67c588d36910aefd827b9e"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e">TS_STATIC_INSTANCE</a>(ObjectClass,  ObjectArgs,  StaticInstanceClass)</td></tr>
<tr class="memdesc:abc69775def67c588d36910aefd827b9e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Local declaration of a static object regardless of modules initialization order.  <a href="#abc69775def67c588d36910aefd827b9e">More...</a><br /></td></tr>
<tr class="separator:abc69775def67c588d36910aefd827b9e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a71780053a45d5fee9242f146812234f6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ts_static_instance_8h.html#a71780053a45d5fee9242f146812234f6">TS_STATIC_INSTANCE_DECLARATION</a>(ObjectClass,  ClassAttributes,  StaticInstanceClass)</td></tr>
<tr class="memdesc:a71780053a45d5fee9242f146812234f6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Declaration of a static object regardless of modules initialization order.  <a href="#a71780053a45d5fee9242f146812234f6">More...</a><br /></td></tr>
<tr class="separator:a71780053a45d5fee9242f146812234f6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac807bb137d13176b0e8a9416794d6851"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ts_static_instance_8h.html#ac807bb137d13176b0e8a9416794d6851">TS_STATIC_INSTANCE_DEFINITION</a>(ObjectClass,  ObjectArgs,  StaticInstancePath,  StaticInstanceClass)</td></tr>
<tr class="memdesc:ac807bb137d13176b0e8a9416794d6851"><td class="mdescLeft">&#160;</td><td class="mdescRight">Definition of a static object regardless of modules initialization order.  <a href="#ac807bb137d13176b0e8a9416794d6851">More...</a><br /></td></tr>
<tr class="separator:ac807bb137d13176b0e8a9416794d6851"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Declare the initialization-order-safe macros for static object instances. </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a71780053a45d5fee9242f146812234f6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a71780053a45d5fee9242f146812234f6">&#9670;&nbsp;</a></span>TS_STATIC_INSTANCE_DECLARATION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TS_STATIC_INSTANCE_DECLARATION</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ObjectClass, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ClassAttributes, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">StaticInstanceClass&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Declaration of a static object regardless of modules initialization order. </p>
<p>This macro expands to the <em>declaration</em> part of the static instance. See <a class="el" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e">TS_STATIC_INSTANCE</a> for more details on the usage of static instances.</p>
<p>The macro <a class="el" href="ts_static_instance_8h.html#a71780053a45d5fee9242f146812234f6">TS_STATIC_INSTANCE_DECLARATION</a> is used in cunjunction with its counterpart <a class="el" href="ts_static_instance_8h.html#ac807bb137d13176b0e8a9416794d6851">TS_STATIC_INSTANCE_DEFINITION</a>. They are used when the static instance must be publicly accessible or declared in a specific namespace.</p>
<p>Most of the time, a static instance is used privately inside a module and declared in the anonymous namespace. In this general case, the macro <a class="el" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e">TS_STATIC_INSTANCE</a> is a simpler alternative.</p>
<p>In the unusual case where you need to make a static instance publicly available, use the macro <a class="el" href="ts_static_instance_8h.html#a71780053a45d5fee9242f146812234f6">TS_STATIC_INSTANCE_DECLARATION</a> in the header file and the macro <a class="el" href="ts_static_instance_8h.html#ac807bb137d13176b0e8a9416794d6851">TS_STATIC_INSTANCE_DEFINITION</a> in the C++ body file as illustrated below.</p>
<p>In the header file (.h) of the module, we declare a static instance of <code>std::string</code> in the namespace <code>ts::foo</code>. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespacets.html">ts</a> {</div><div class="line">    <span class="keyword">namespace </span>foo {</div><div class="line">        <a class="code" href="ts_static_instance_8h.html#a71780053a45d5fee9242f146812234f6">TS_STATIC_INSTANCE_DECLARATION</a>(std::string, <a class="code" href="ts_platform_8h.html#ae1cda62454d23e62fb576be3783aec47">TSDUCKDLL</a>, Bar);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>In the definition body file (.cpp) of the module: </p><div class="fragment"><div class="line"><a class="code" href="ts_static_instance_8h.html#ac807bb137d13176b0e8a9416794d6851">TS_STATIC_INSTANCE_DEFINITION</a>(std::string, (<span class="stringliteral">&quot;initial value&quot;</span>), ts::foo::Bar, Bar);</div></div><!-- fragment --><p>In application code, we use the static instance of string as follow: </p><div class="fragment"><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;static string instance: &quot;</span> &lt;&lt; ts::foo::Bar::Instance() &lt;&lt; std::endl;</div></div><!-- fragment --><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ObjectClass</td><td>The name of the class of the static object. This must be an existing class. </td></tr>
    <tr><td class="paramname">ClassAttributes</td><td>Attributes of StaticInstanceClass, typically TSDUCKDLL or empty. </td></tr>
    <tr><td class="paramname">StaticInstanceClass</td><td>The name of the new class which encapsulates the static instance. This class is declared by the expansion of the macro.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e" title="Local declaration of a static object regardless of modules initialization order. ">TS_STATIC_INSTANCE</a> for more details on the usage of static instances. </dd>
<dd>
<a class="el" href="ts_static_instance_8h.html#ac807bb137d13176b0e8a9416794d6851" title="Definition of a static object regardless of modules initialization order. ">TS_STATIC_INSTANCE_DEFINITION</a> for the <em>definition</em> part. </dd></dl>

</div>
</div>
<a id="ac807bb137d13176b0e8a9416794d6851"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac807bb137d13176b0e8a9416794d6851">&#9670;&nbsp;</a></span>TS_STATIC_INSTANCE_DEFINITION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TS_STATIC_INSTANCE_DEFINITION</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ObjectClass, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ObjectArgs, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">StaticInstancePath, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">StaticInstanceClass&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition of a static object regardless of modules initialization order. </p>
<p>This macro expands to the <em>definition</em> part of the static instance.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ObjectClass</td><td>The name of the class of the static object. This must be an existing class. </td></tr>
    <tr><td class="paramname">ObjectArgs</td><td>The initializer list, enclosed within parentheses, of the constructor of the static instance. Use () if there is no initializer. </td></tr>
    <tr><td class="paramname">StaticInstancePath</td><td>The full name, including namespaces if any, of the new class which encapsulates the static instance. This class is defined by the expansion of the macro. </td></tr>
    <tr><td class="paramname">StaticInstanceClass</td><td>The simple name, without namespace, of the new class which encapsulates the static instance. This is the class name part of <em>StaticInstancePath</em>. If there is no namespace, <em>StaticInstancePath</em> and <em>StaticInstanceClass</em> are identical.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e" title="Local declaration of a static object regardless of modules initialization order. ">TS_STATIC_INSTANCE</a> for more details on the usage of static instances. </dd>
<dd>
<a class="el" href="ts_static_instance_8h.html#a71780053a45d5fee9242f146812234f6" title="Declaration of a static object regardless of modules initialization order. ">TS_STATIC_INSTANCE_DECLARATION</a> for the <em>declaration</em> part and usage examples. </dd></dl>

</div>
</div>
<a id="abc69775def67c588d36910aefd827b9e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abc69775def67c588d36910aefd827b9e">&#9670;&nbsp;</a></span>TS_STATIC_INSTANCE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TS_STATIC_INSTANCE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ObjectClass, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ObjectArgs, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">StaticInstanceClass&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Local declaration of a static object regardless of modules initialization order. </p>
<h3>The static initialization order nightmare</h3>
<p>In C++, each module needs to be initialized. For each module, the compiler potentially generates an initialization routine. This initialization routine is responsible for constructing the static objects in the module. The initialization routines of all modules are executed <em>before</em> entering the <code>main()</code> function of the application.</p>
<p>A static object is defined inside one module. When the static object has an elementary type or a pointer type and is initialized by a static value (i.e. a compile-time, link-time or load-time expression), the initial value of the object is ready <em>before</em> the application starts, before the execution of all initialization routines of all modules. However, when the static object has a class type, its initialization is the invocation of a constructor. This constructor is invoked by the initialization routine of the module.</p>
<p>When a static object is used by the application, after entering the <code>main()</code> function of the application, it is guaranteed that all initialization routines have completed and, consequently, all static objects are fully constructed.</p>
<p>However, there are cases where a static object is used by the initialization routine of another module. This is typically the case when a static object references another static object in its constructor. Usually, this is not as obvious as it seems. If the constructor of a static object in module A invokes a static method from another module B, you do not know if this static method does or does not use a static object in the module B. In this case, for the application to work properly, it is necessary that the module B is initialized before the module A.</p>
<p>The problem is that there is no way in the C++ language to determine the execution order of the initialization routines of the various modules. The order is undefined and implementation dependent. In the previous example, it is possible that the initialization routine of the module B is executed before the initialization routine of the module A on a platform 1. On this platform, the application works correctly. But a platform 2 is also allowed to invoke the initialization routines in the reverse order. Consequently, on this platform, the application will most certainly crash.</p>
<p>To avoid this, you may simply ban all static objects in your coding rules. However, if you find this too restrictive, alternate solutions must be found.</p>
<p>The obvious solution is the singleton pattern (see the file <a class="el" href="ts_singleton_manager_8h.html">tsSingletonManager.h</a>). In this pattern, no object is constructed at initialization. A pointer is statically initialized to zero, which is guaranteed to work. The first time the object is requested, it is allocated, stored in this static pointer and reused every other time. However, for this to work in a multithreaded environment, the test-and-creation sequence must be protected by a mutex in the same module. And this mutex must be ... statically initialized !</p>
<p>So, there is still a requirement for a solution for the mutex, at least. And this solution is intrinsicly thread-unsafe. So, the solution must reduce the race condition risk to the minimum, typically by making the best effort to create the critical static objects as soon as possible, hopefully before the creation of the first thread.</p>
<p>This is the purpose of the macros <a class="el" href="ts_static_instance_8h.html#a71780053a45d5fee9242f146812234f6">TS_STATIC_INSTANCE_DECLARATION</a> and <a class="el" href="ts_static_instance_8h.html#ac807bb137d13176b0e8a9416794d6851">TS_STATIC_INSTANCE_DEFINITION</a> with the associated "shortcut" macro <a class="el" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e">TS_STATIC_INSTANCE</a>.</p>
<h3>Using the TS_STATIC_INSTANCE macros</h3>
<p>You need a static object. The type for this object is the parameter <em>ObjectClass</em> in the various TS_STATIC_INSTANCE macros.</p>
<p>The macros create an encapsulating local class for each static object. The name of this local class is the parameter <em>StaticInstanceClass</em> in the macros. This class has one public static method named <code>Instance()</code> which returns a reference to the static object. The static object is allocated during the initialization of the application, no later than during the initialization of the module where it is defined but possibly earlier if the static object is referenced before the initialization of the module where it is defined.</p>
<p>Thus, the initialization order problem is avoided. But, on the downside, the unique construction of the object is not thread-safe. Consequently, the object shall not be accessed by concurrent threads during the initialization phase of the application.</p>
<p>The initializers of the object are grouped into the parameter <em>ObjectArgs</em> of the macros. This is the argument list, including the pair of enclosing parentheses, of the constructor of the object.</p>
<p>The macro <a class="el" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e">TS_STATIC_INSTANCE</a> creates a static object inside the anonymous namespace of the module where it is expanded.</p>
<p>Example using the <code>std::string</code> type: Two static objects <code>Foo1</code> and <code>Foo2</code> are created. Remember that <code>Foo1</code> and <code>Foo2</code> are not the name of objects but the names of the encapsulating classes of the objects. The first static object is initialized by the default constructor and the parameter <em>ObjectArgs</em> of the macro is simply the empty argument list <code>()</code>. The second static object is built by the constructor <code>std::string (size_t, char)</code> and the parameter <em>ObjectArgs</em> is a list of two parameters <code>(4, '=')</code>.</p>
<div class="fragment"><div class="line"><a class="code" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e">TS_STATIC_INSTANCE</a>(std::string, (), Foo1)</div><div class="line"><a class="code" href="ts_static_instance_8h.html#abc69775def67c588d36910aefd827b9e">TS_STATIC_INSTANCE</a>(std::string, (4, <span class="charliteral">&#39;=&#39;</span>), Foo2)</div><div class="line">....</div><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Foo1: &quot;</span> &lt;&lt; Foo1::Instance() &lt;&lt; std::endl;</div><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Foo2: &quot;</span> &lt;&lt; Foo2::Instance() &lt;&lt; std::endl;</div></div><!-- fragment --><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ObjectClass</td><td>The name of the class of the static object. This must be an existing class. </td></tr>
    <tr><td class="paramname">ObjectArgs</td><td>The initializer list, enclosed within parentheses, of the constructor of the static instance. Use () if there is no initializer. </td></tr>
    <tr><td class="paramname">StaticInstanceClass</td><td>The name of the new class which encapsulates the static instance. This class is declared by the expansion of the macro. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.12-->
<!-- start footer part -->
</body>
</html>
